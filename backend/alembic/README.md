# Alembic Database Migrations

## Overview

This project uses Alembic for database schema migrations. Alembic tracks changes to your database schema and allows you to version control your database structure.

## üìö Documentation

- **üìñ Complete Guide**: See `MIGRATION_GUIDE.md` for detailed step-by-step instructions
- **‚ö° Quick Reference**: Commands below

## Initial Setup

### If you have an existing database (created via `create_all()`):

1. **Mark current state as migrated** (tells Alembic that current tables are the baseline):
   ```bash
   cd backend
   alembic stamp head
   ```

2. **Generate initial migration from current models**:
   ```bash
   alembic revision --autogenerate -m "Initial migration from models"
   ```

3. **Review the generated migration** in `alembic/versions/` to ensure it's correct

4. **Apply the migration** (optional, since tables already exist):
   ```bash
   alembic upgrade head
   ```

### If you have a fresh database:

1. **Generate initial migration**:
   ```bash
   cd backend
   alembic revision --autogenerate -m "Initial migration"
   ```

2. **Review the generated migration** in `alembic/versions/`

3. **Apply the migration**:
   ```bash
   alembic upgrade head
   ```

## Common Commands

### Generate a new migration (automatic):
```bash
cd backend
alembic revision --autogenerate -m "Description of changes"
```

### Apply all pending migrations:
```bash
cd backend
alembic upgrade head
```

### Apply one migration at a time:
```bash
cd backend
alembic upgrade +1
```

### Rollback last migration:
```bash
cd backend
alembic downgrade -1
```

### Rollback all migrations:
```bash
cd backend
alembic downgrade base
```

### Check current migration status:
```bash
cd backend
alembic current
```

### View migration history:
```bash
cd backend
alembic history
```

## Configuration

- **Database URL**: Set via `DATABASE_URL` environment variable or in `app/core/config.py`
- **Migration scripts**: Located in `backend/alembic/versions/`
- **Configuration**: `backend/alembic.ini` and `backend/alembic/env.py`

## Important Notes

- **Never edit existing migrations** that have been applied to production
- **Always review autogenerated migrations** before applying them
- **Test migrations** on a development database first
- **In production**: Always run `alembic upgrade head` before starting the server
- **Development mode**: Currently uses `create_all()` for convenience, but Alembic is preferred for production

## üéØ Current Status (TIER 3)

- ‚úÖ Alembic configured and ready
- ‚úÖ Models connected for autogenerate
- ‚úÖ Composite indexes defined in models:
  - `ix_workouts_user_id_start_time` - For user workouts ordered by date
  - `ix_workouts_start_time` - For date range queries
  - `ix_health_metrics_user_id_date` - For user health metrics by date
- ‚è≥ Initial migration pending (see `MIGRATION_GUIDE.md` for instructions)

**Note**: The composite indexes (TIER 3) will be included when you generate the initial migration.

## Troubleshooting

### Migration conflicts:
If you have conflicts with existing database state:
```bash
# Mark current state
alembic stamp head

# Generate new migration
alembic revision --autogenerate -m "Fix conflicts"
```

### Missing tables:
If migrations are out of sync:
```bash
# Check current state
alembic current

# Apply missing migrations
alembic upgrade head
```
